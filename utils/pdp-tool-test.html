<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse PDP Testing Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: #444;
            border-bottom: 2px solid #007cba;
            padding-bottom: 10px;
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            height: 80px;
            resize: vertical;
        }

        button {
            background-color: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        button:hover {
            background-color: #005a8b;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .network-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .network-option {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .network-option.selected {
            border-color: #007cba;
            background-color: #e7f3ff;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .piece-entry {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #fafafa;
        }

        .piece-entry h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .add-piece-btn,
        .remove-piece-btn {
            background-color: #28a745;
            font-size: 14px;
            padding: 5px 10px;
        }

        .remove-piece-btn {
            background-color: #dc3545;
        }

        .add-piece-btn:hover {
            background-color: #218838;
        }

        .remove-piece-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Synapse PDP Testing Tool</h1>
        <div class="form-group">
            <label>Network:</label>
            <div class="network-selector">
                <div class="network-option selected" data-network="calibration">
                    <strong>Calibration Testnet</strong><br>
                    <small>Chain ID: 314159</small>
                </div>
                <div class="network-option" data-network="mainnet">
                    <strong>Mainnet</strong><br>
                    <small>Chain ID: 314</small>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>Wallet Connection:</label>
            <button id="connectWalletBtn">Connect MetaMask</button>
            <div id="walletStatus" class="help-text">Click to connect your MetaMask wallet for signing</div>
        </div>
        <div class="form-group">
            <label for="pdpEndpoint">PDP Server Endpoint:</label>
            <input type="text" id="pdpEndpoint" value="" placeholder="e.g., https://pdp.example.com" />
            <div class="help-text">The URL of the PDP server (Curio) to interact with</div>
        </div>
        <div class="form-group">
            <label for="warmStorageAddress">Warm Storage Contract:</label>
            <input type="text" id="warmStorageAddress" value="" placeholder="Will be auto-filled based on network" />
            <div class="help-text">Address of the Warm Storage service contract</div>
        </div>
        <!-- SERVICE PROVIDERS SECTION -->
        <div class="section">
            <h2>Service Providers</h2>
            <div class="form-group">
                <button id="listProvidersBtn">List Approved Providers</button>
                <div class="help-text">View all service providers approved to use this Warm Storage service</div>
            </div>
            <div id="providersStatus" class="status info" style="display: none; margin-top: 10px;"></div>
        </div>
        <!-- CREATE DATA SET SECTION -->
        <div class="section">
            <h2>Create Data Set</h2>
            <div class="form-group">
                <label for="payee">Service Provider Address:</label>
                <input type="text" id="payee" value="" placeholder="0x..." />
                <div class="help-text">Address of the service provider that will receive payments (must be whitelisted
                    in Warm Storage)</div>
            </div>
            <div class="form-group">
                <label for="clientDataSetId">Client Dataset ID:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="clientDataSetId" value="0" style="flex: 1;" />
                    <button type="button" id="autoFillClientDataSetId" class="add-piece-btn" disabled>Auto-fill</button>
                </div>
                <div class="help-text">Unique identifier for your dataset (click Auto-fill to get next available ID)
                </div>
            </div>
            <div class="form-group">
                <label for="withCDN">Enable CDN:</label>
                <select id="withCDN">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                </select>
                <div class="help-text">Whether to enable CDN services for faster retrieval</div>
            </div>
            <div class="form-group">
                <button id="createDataSetBtn" disabled>Create Data Set</button>
                <button id="checkStatusBtn" disabled>Check Status</button>
                <button id="autoMonitorBtn" disabled style="background-color: #28a745;">Auto-Monitor</button>
            </div>
        </div>
        <!-- ADD PIECES SECTION -->
        <div class="section">
            <h2>Add Pieces to Data Set</h2>
            <div class="form-group">
                <label for="pdpVerifierDataSetId">Data Set ID:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="pdpVerifierDataSetId" value="" style="flex: 1;" />
                    <button type="button" id="discoverDataSets" class="add-piece-btn" disabled>Discover</button>
                </div>
                <div class="help-text">Data set ID to add pieces to (click Discover to see your data sets)</div>
            </div>
            <div class="form-group">
                <label for="addPiecesClientDataSetId">Client Dataset ID:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="addPiecesClientDataSetId" value="0" style="flex: 1;" />
                    <button type="button" id="autoFillAddPiecesInfo" class="add-piece-btn" disabled>Auto-fill</button>
                </div>
                <div class="help-text">Unique identifier for your dataset (click Auto-fill to get from data set)</div>
            </div>
            <div class="form-group">
                <label for="nextPieceId">Next Piece ID:</label>
                <input type="number" id="nextPieceId" value="0" />
                <div class="help-text">The next piece ID for this data set (auto-filled when you select a data set)
                </div>
            </div>
            <div class="form-group">
                <label>Piece Data Entries:</label>
                <div class="help-text">Add the piece CIDs and their raw data sizes to include in the data set</div>
                <div id="pieceEntries">
                    <div class="piece-entry">
                        <h4>Piece Entry 1</h4>
                        <div style="margin-bottom: 10px;">
                            <label>Piece CID:</label>
                            <input type="text" class="piece-cid"
                                placeholder="e.g., bafkzcibeqcad6efnpwn62p5vvs5x3nh3j7xkzfgb3xtitcdm2hulmty3xx4tl3wace" />
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>Raw Size (bytes):</label>
                            <input type="number" class="piece-size" placeholder="e.g., 1048576" />
                        </div>
                        <button type="button" class="remove-piece-btn" onclick="removePieceEntry(this)">Remove</button>
                    </div>
                </div>
                <button type="button" class="add-piece-btn" onclick="addPieceEntry()">Add Another Piece</button>
            </div>
            <div class="form-group">
                <button id="addPiecesBtn" disabled>Add Pieces</button>
            </div>
        </div>
        <!-- MONITOR DATA SET SECTION -->
        <div class="section">
            <h2>Monitor Data Set</h2>
            <div class="form-group">
                <label for="monitorTxHash">Transaction Hash:</label>
                <input type="text" id="monitorTxHash" placeholder="0x..." />
                <div class="help-text">Enter a data set creation transaction hash to monitor its status</div>
            </div>
            <div class="form-group">
                <button id="monitorTxBtn">Check Transaction Status</button>
            </div>
        </div>
        <div id="status" class="status info" style="display: none;"></div>
    </div>
    <!-- Load ethers from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <!-- Load Synapse SDK browser bundle -->
    <script src="../dist/browser/synapse-sdk.min.js"></script>
    <script>
        // The SDK is now available as window.SynapseSDK
        const { PDPAuthHelper, PDPServer, WarmStorageService } = window.SynapseSDK;

        // Use CONTRACT_ADDRESSES from the SDK
        const { CONTRACT_ADDRESSES } = window.SynapseSDK;

        let currentNetwork = 'calibration'
        let currentTxHash = null
        let connectedSigner = null
        let connectedAddress = null
        let pieceEntryCounter = 1
        let warmStorageService = null
        let provider = null

        // Network selection
        document.querySelectorAll('.network-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.network-option').forEach(o => { o.classList.remove('selected') })
                option.classList.add('selected')
                currentNetwork = option.dataset.network
                updateContractAddress()
            })
        })

        function updateContractAddress() {
            const warmStorageInput = document.getElementById('warmStorageAddress')
            warmStorageInput.value = CONTRACT_ADDRESSES.WARM_STORAGE[currentNetwork] || ''
        }

        // Piece entry management
        function _addPieceEntry() {
            pieceEntryCounter++
            const pieceEntries = document.getElementById('pieceEntries')
            const newEntry = document.createElement('div')
            newEntry.className = 'piece-entry'
            newEntry.innerHTML = `
                <h4>Piece Entry ${pieceEntryCounter}</h4>
                <div style="margin-bottom: 10px;">
                    <label>Piece CID:</label>
                    <input type="text" class="piece-cid" placeholder="e.g., bafkzcibeqcad6efnpwn62p5vvs5x3nh3j7xkzfgb3xtitcdm2hulmty3xx4tl3wace" />
                </div>
                <div style="margin-bottom: 10px;">
                    <label>Raw Size (bytes):</label>
                    <input type="number" class="piece-size" placeholder="e.g., 1048576" />
                </div>
                <button type="button" class="remove-piece-btn" onclick="removePieceEntry(this)">Remove</button>
            `
            pieceEntries.appendChild(newEntry)
        }

        function _removePieceEntry(button) {
            const pieceEntries = document.getElementById('pieceEntries')
            if (pieceEntries.children.length > 1) {
                button.parentElement.remove()
            } else {
                showStatus('Cannot remove the last piece entry. At least one piece entry is required.', 'error')
            }
        }

        // MetaMask connection functionality
        async function connectMetaMask() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask is not installed. Please install MetaMask browser extension.')
                }

                showStatus('Connecting to MetaMask...', 'info')

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' })

                if (accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask.')
                }

                // Create ethers provider and signer for MetaMask
                provider = new ethers.BrowserProvider(window.ethereum)
                connectedSigner = await provider.getSigner()
                connectedAddress = accounts[0]

                // Check network
                const network = await provider.getNetwork()
                const expectedChainId = currentNetwork === 'mainnet' ? 314 : 314159

                if (Number(network.chainId) !== expectedChainId) {
                    showStatus(`Wrong network! Please switch to ${currentNetwork === 'mainnet' ? 'Filecoin Mainnet' : 'Calibration Testnet'} (Chain ID: ${expectedChainId})`, 'error')
                    return
                }


                // Update UI
                document.getElementById('connectWalletBtn').textContent = 'Connected'
                document.getElementById('connectWalletBtn').disabled = true
                document.getElementById('walletStatus').textContent = `Connected: ${connectedAddress.slice(0, 6)}...${connectedAddress.slice(-4)} on ${currentNetwork === 'mainnet' ? 'Mainnet' : 'Calibration'}`
                document.getElementById('createDataSetBtn').disabled = false
                document.getElementById('addPiecesBtn').disabled = false
                document.getElementById('autoFillClientDataSetId').disabled = false
                document.getElementById('discoverDataSets').disabled = false
                document.getElementById('autoFillAddPiecesInfo').disabled = false

                // Create Warm StorageService instance
                const warmStorageAddress = document.getElementById('warmStorageAddress').value
                warmStorageService = new WarmStorageService(provider, warmStorageAddress)

                showStatus(`Successfully connected to MetaMask!
Address: ${connectedAddress}
Network: ${currentNetwork === 'mainnet' ? 'Filecoin Mainnet' : 'Calibration Testnet'} (${network.chainId})
Warm Storage: ${warmStorageAddress}`, 'success')

            } catch (error) {
                console.error('MetaMask connection error:', error)
                showStatus(`Failed to connect to MetaMask: ${error.message}`, 'error')

                // Reset connection state
                connectedSigner = null
                connectedAddress = null
                document.getElementById('connectWalletBtn').textContent = 'Connect MetaMask'
                document.getElementById('connectWalletBtn').disabled = false
                document.getElementById('walletStatus').textContent = 'Click to connect your MetaMask wallet for signing'
                document.getElementById('createDataSetBtn').disabled = true
                document.getElementById('addPiecesBtn').disabled = true
            }
        }

        // Network change handler
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => {
                // Reload page on network change to reset connection
                window.location.reload()
            })

            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // User disconnected
                    connectedSigner = null
                    connectedAddress = null
                    document.getElementById('connectWalletBtn').textContent = 'Connect MetaMask'
                    document.getElementById('connectWalletBtn').disabled = false
                    document.getElementById('walletStatus').textContent = 'Click to connect your MetaMask wallet for signing'
                    document.getElementById('createDataSetBtn').disabled = true
                    document.getElementById('addPiecesBtn').disabled = true
                    showStatus('MetaMask disconnected', 'info')
                } else {
                    // Account changed, reconnect
                    connectMetaMask()
                }
            })
        }

        document.getElementById('connectWalletBtn').addEventListener('click', connectMetaMask)

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status')
            statusDiv.textContent = message
            statusDiv.className = `status ${type}`
            statusDiv.style.display = 'block'
        }

        function validateInputs() {
            const pdpEndpoint = document.getElementById('pdpEndpoint').value
            const warmStorageAddress = document.getElementById('warmStorageAddress').value

            if (!connectedSigner) {
                throw new Error('Please connect your MetaMask wallet first')
            }

            if (!pdpEndpoint || !pdpEndpoint.startsWith('http')) {
                throw new Error('Please enter a valid PDP endpoint URL')
            }

            if (!warmStorageAddress || !ethers.isAddress(warmStorageAddress)) {
                throw new Error('Please enter a valid Warm Storage contract address')
            }

            return { pdpEndpoint, warmStorageAddress }
        }

        function validateCreateDataSetInputs() {
            const { pdpEndpoint, warmStorageAddress } = validateInputs()
            const payee = document.getElementById('payee').value

            if (!payee || !ethers.isAddress(payee)) {
                throw new Error('Please enter a valid service provider address')
            }

            return { pdpEndpoint, warmStorageAddress, payee }
        }

        function validateAddPiecesInputs() {
            const { pdpEndpoint, warmStorageAddress } = validateInputs()

            const pdpVerifierDataSetId = parseInt(document.getElementById('pdpVerifierDataSetId').value, 10)
            const clientDataSetId = parseInt(document.getElementById('addPiecesClientDataSetId').value, 10)
            const nextPieceId = parseInt(document.getElementById('nextPieceId').value, 10)

            if (Number.isNaN(pdpVerifierDataSetId) || pdpVerifierDataSetId < 0) {
                throw new Error('Please enter a valid data set ID (use Discover to auto-fill)')
            }

            if (Number.isNaN(clientDataSetId) || clientDataSetId < 0) {
                throw new Error('Please enter a valid client dataset ID')
            }

            if (Number.isNaN(nextPieceId) || nextPieceId < 0) {
                throw new Error('Please enter a valid next piece ID')
            }

            // Validate piece entries
            const pieceEntries = document.querySelectorAll('.piece-entry')
            const pieceDataArray = []

            for (let i = 0; i < pieceEntries.length; i++) {
                const entry = pieceEntries[i]
                const cidInput = entry.querySelector('.piece-cid')
                const sizeInput = entry.querySelector('.piece-size')

                const cid = cidInput.value.trim()
                const rawSize = parseInt(sizeInput.value, 10)

                if (!cid) {
                    throw new Error(`Piece entry ${i + 1}: Please enter a piece CID`)
                }

                if (Number.isNaN(rawSize) || rawSize <= 0) {
                    throw new Error(`Piece entry ${i + 1}: Please enter a valid raw size (positive number)`)
                }

                pieceDataArray.push({
                    cid: cid,
                    rawSize: rawSize
                })
            }

            if (pieceDataArray.length === 0) {
                throw new Error('Please add at least one piece entry')
            }

            return { pdpEndpoint, warmStorageAddress, pdpVerifierDataSetId, clientDataSetId, nextPieceId, pieceDataArray }
        }

        // Create Data Set functionality
        document.getElementById('createDataSetBtn').addEventListener('click', async () => {
            try {
                showStatus('Validating inputs...', 'info')

                const { pdpEndpoint, warmStorageAddress, payee } = validateCreateDataSetInputs()
                const clientDataSetId = parseInt(document.getElementById('clientDataSetId').value, 10)
                const withCDN = document.getElementById('withCDN').value === 'true'


                showStatus('Creating PDP auth helper and server...', 'info')

                // Create auth helper and PDPServer using connected MetaMask signer
                const chainId = currentNetwork === 'mainnet' ? 314 : 314159
                const authHelper = new PDPAuthHelper(warmStorageAddress, connectedSigner, chainId)
                const pdpServer = new PDPServer(authHelper, pdpEndpoint, pdpEndpoint)

                showStatus('Signing and sending data set creation...', 'info')

                // Create data set using the SDK's PDPServer
                const result = await pdpServer.createDataSet(clientDataSetId, payee, withCDN, warmStorageAddress)

                currentTxHash = result.txHash
                document.getElementById('checkStatusBtn').disabled = false
                document.getElementById('autoMonitorBtn').disabled = false

                showStatus(`Data set creation submitted successfully!
Transaction Hash: ${result.txHash}
Status URL: ${result.statusUrl}

Starting automatic monitoring...`, 'success')

                // Automatically start monitoring the transaction
                startStatusPolling()

            } catch (error) {
                console.error('Error creating data set:', error)
                showStatus(`Error: ${error.message}`, 'error')
            }
        })

        // Add Pieces functionality
        document.getElementById('addPiecesBtn').addEventListener('click', async () => {
            try {
                showStatus('Validating inputs...', 'info')

                const { pdpEndpoint, warmStorageAddress, pdpVerifierDataSetId, clientDataSetId, nextPieceId, pieceDataArray } = validateAddPiecesInputs()


                showStatus('Creating PDP auth helper and server...', 'info')

                // Create auth helper and PDPServer using connected MetaMask signer
                const chainId = currentNetwork === 'mainnet' ? 314 : 314159
                const authHelper = new PDPAuthHelper(warmStorageAddress, connectedSigner, chainId)
                const pdpServer = new PDPServer(authHelper, pdpEndpoint, pdpEndpoint)

                showStatus('Signing and sending add pieces request...', 'info')

                // Add pieces using the SDK's PDPServer (uses PDPVerifier data set ID)
                const result = await pdpServer.addPieces(pdpVerifierDataSetId, clientDataSetId, nextPieceId, pieceDataArray)

                showStatus(`Pieces added successfully!
${result.message}

Data Set ID: ${pdpVerifierDataSetId}
Total pieces added: ${pieceDataArray.length}
Next piece ID will be: ${nextPieceId + pieceDataArray.length}`, 'success')

            } catch (error) {
                console.error('Error adding pieces:', error)
                showStatus(`Error: ${error.message}`, 'error')
            }
        })

        // Check Status functionality with comprehensive checking
        document.getElementById('checkStatusBtn').addEventListener('click', async () => {
            if (!currentTxHash) {
                showStatus('No transaction hash available. Create a data set first.', 'error')
                return
            }

            try {
                showStatus('Checking comprehensive data set creation status...', 'info')

                const { pdpEndpoint, warmStorageAddress } = validateInputs()

                // Create PDPServer for status checking
                const authHelper = new PDPAuthHelper(warmStorageAddress, connectedSigner, currentNetwork === 'mainnet' ? 314 : 314159)
                const pdpServer = new PDPServer(authHelper, pdpEndpoint, pdpEndpoint)

                // Get comprehensive status using Warm StorageService
                const comprehensiveStatus = await warmStorageService.getComprehensiveDataSetStatus(
                    currentTxHash,
                    pdpServer
                )

                // Build detailed status message
                let statusMessage = `üîç Comprehensive Data Set Status:\n\n`

                // Summary details
                statusMessage += `üìä Overall Status: ${comprehensiveStatus.summary.isComplete ? 'Complete' : 'In Progress'}\n`
                if (comprehensiveStatus.summary.error) {
                    statusMessage += `‚ùå Error: ${comprehensiveStatus.summary.error}\n`
                }
                if (comprehensiveStatus.summary.dataSetId) {
                    statusMessage += `‚úÖ Data Set ID: ${comprehensiveStatus.summary.dataSetId}\n`
                }
                statusMessage += `\n`

                // Chain verification details
                const chain = comprehensiveStatus.chainStatus
                statusMessage += `‚õìÔ∏è On-Chain Verification:\n`
                statusMessage += `  ‚Ä¢ Transaction Mined: ${chain.transactionMined ? '‚úÖ' : '‚è≥'}\n`
                if (chain.transactionMined) {
                    statusMessage += `  ‚Ä¢ Transaction Success: ${chain.transactionSuccess ? '‚úÖ' : '‚ùå'}\n`
                    statusMessage += `  ‚Ä¢ Block Number: ${chain.blockNumber ?? 'N/A'}\n`
                    statusMessage += `  ‚Ä¢ Gas Used: ${chain.gasUsed != null ? chain.gasUsed.toString() : 'N/A'}\n`
                }
                if (chain.dataSetId != null) {
                    statusMessage += `  ‚Ä¢ Data Set ID: ${chain.dataSetId}\n`
                    statusMessage += `  ‚Ä¢ Data Set Live: ${chain.dataSetLive ? '‚úÖ' : '‚ùå'}\n`
                }
                if (chain.error) {
                    statusMessage += `  ‚Ä¢ Error: ${chain.error}\n`
                }
                statusMessage += `\n`

                // PDP server status details (if available)
                if (comprehensiveStatus.serverStatus) {
                    const pdpServerStatus = comprehensiveStatus.serverStatus
                    statusMessage += `üñ•Ô∏è PDP Server Status:\n`
                    statusMessage += `  ‚Ä¢ Service: ${pdpServerStatus.service}\n`
                    statusMessage += `  ‚Ä¢ TX Status: ${pdpServerStatus.txStatus}\n`
                    statusMessage += `  ‚Ä¢ Success: ${pdpServerStatus.ok === null ? 'Pending' : (pdpServerStatus.ok ? '‚úÖ' : '‚ùå')}\n`
                    statusMessage += `  ‚Ä¢ Data Set Created: ${pdpServerStatus.dataSetCreated ? '‚úÖ' : '‚ùå'}\n`
                    if (pdpServerStatus.dataSetId) {
                        statusMessage += `  ‚Ä¢ Server Data Set ID: ${pdpServerStatus.dataSetId}\n`
                    }
                } else {
                    statusMessage += `üñ•Ô∏è PDP Server Status: Not available (using chain verification only)\n`
                }

                // Determine status type based on overall assessment
                const statusType = comprehensiveStatus.summary.error
                    ? 'error'
                    : (comprehensiveStatus.summary.isComplete ? 'success' : 'info')

                showStatus(statusMessage, statusType)

                // Auto-populate data set ID for add pieces if creation succeeded
                if (chain.dataSetLive && chain.dataSetId != null) {
                    document.getElementById('pdpVerifierDataSetId').value = chain.dataSetId

                    // Also try to get the additional info for this new data set
                    try {
                        const dataSets = await warmStorageService.getClientDataSetsWithDetails(connectedAddress)
                        const newDataSet = dataSets.find(ps => ps.pdpVerifierDataSetId === chain.dataSetId)
                        if (newDataSet) {
                            document.getElementById('addPiecesClientDataSetId').value = newDataSet.clientDataSetId
                            document.getElementById('nextPieceId').value = newDataSet.nextPieceId
                        }
                    } catch {
                        // Ignore errors here, the data set ID is the important part
                    }

                    showStatus(`${statusMessage}\n‚ú® Auto-populated data set ID ${chain.dataSetId} for adding pieces!`, statusType)
                }

            } catch (error) {
                console.error('Error checking comprehensive status:', error)
                showStatus(`Error checking status: ${error.message}`, 'error')
            }
        })

        // Auto-polling status checker for active transactions
        let statusPollingInterval = null

        function startStatusPolling() {
            if (!currentTxHash || statusPollingInterval) return

            showStatus('Starting automatic status monitoring...', 'info')
            updateMonitoringUI(true)

            statusPollingInterval = setInterval(async () => {
                try {
                    const { pdpEndpoint, warmStorageAddress } = validateInputs()
                    const authHelper = new PDPAuthHelper(warmStorageAddress, connectedSigner, currentNetwork === 'mainnet' ? 314 : 314159)
                    const pdpServer = new PDPServer(authHelper, pdpEndpoint, pdpEndpoint)

                    const status = await warmStorageService.getComprehensiveDataSetStatus(
                        currentTxHash,
                        pdpServer
                    )

                    // Update UI with current status
                    const shortStatus = `üîÑ Auto-monitoring: ${status.summary.isComplete ? 'Complete' : 'In Progress'}`
                    const statusElement = document.getElementById('status')
                    if (statusElement.textContent.includes('Auto-monitoring')) {
                        statusElement.textContent = shortStatus
                    }

                    // Stop polling if complete
                    if (status.summary.isComplete) {
                        stopStatusPolling()

                        // Trigger full status display
                        document.getElementById('checkStatusBtn').click()
                    }

                } catch (error) {
                    console.error('Auto-polling error:', error)
                    // Don't stop polling on errors - network might be temporary
                }
            }, 3000) // Poll every 3 seconds
        }

        function stopStatusPolling() {
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval)
                statusPollingInterval = null
                updateMonitoringUI(false)
            }
        }

        function updateMonitoringUI(isMonitoring) {
            const autoMonitorBtn = document.getElementById('autoMonitorBtn')
            if (isMonitoring) {
                autoMonitorBtn.textContent = 'Stop Monitoring'
                autoMonitorBtn.style.backgroundColor = '#dc3545' // Red
            } else {
                autoMonitorBtn.textContent = 'Auto-Monitor'
                autoMonitorBtn.style.backgroundColor = '#28a745' // Green
            }
        }

        // Auto-monitor button handler
        document.getElementById('autoMonitorBtn').addEventListener('click', () => {
            if (statusPollingInterval) {
                // Currently monitoring - stop it
                stopStatusPolling()
                showStatus('Stopped automatic monitoring', 'info')
            } else {
                // Not monitoring - start it
                if (!currentTxHash) {
                    showStatus('No transaction to monitor. Create a data set first.', 'error')
                    return
                }
                startStatusPolling()
                updateMonitoringUI(true)
            }
        })

        // Discovery button handlers
        document.getElementById('autoFillClientDataSetId').addEventListener('click', async () => {
            try {
                if (!warmStorageService || !connectedAddress) {
                    showStatus('Please connect your wallet first', 'error')
                    return
                }

                showStatus('Getting next available client dataset ID...', 'info')
                const nextId = await warmStorageService.getNextClientDataSetId(connectedAddress)
                document.getElementById('clientDataSetId').value = nextId
                showStatus(`Next client dataset ID: ${nextId}`, 'success')
            } catch (error) {
                console.error('Error getting next client dataset ID:', error)
                showStatus(`Error: ${error.message}`, 'error')
            }
        })

        document.getElementById('discoverDataSets').addEventListener('click', async () => {
            try {
                if (!warmStorageService || !connectedAddress) {
                    showStatus('Please connect your wallet first', 'error')
                    return
                }

                showStatus('Discovering your data sets with detailed information...', 'info')

                const dataSetsWithDetails = await warmStorageService.getClientDataSetsWithDetails(connectedAddress)
                const managedDataSets = dataSetsWithDetails.filter(ps => ps.isManaged)

                if (dataSetsWithDetails.length === 0) {
                    showStatus('No data sets found for your address in this Warm Storage contract', 'info')
                    return
                }

                // Get unmanaged data sets (those from other Warm Storage contracts)
                const unmanagedDataSets = dataSetsWithDetails.filter(ps => !ps.isManaged)

                let message = `Found ${dataSetsWithDetails.length} data set(s) total:\n\n`

                if (managedDataSets.length > 0) {
                    message += `‚úÖ YOUR DATA SETS (${managedDataSets.length}):\n\n`
                    managedDataSets.forEach((ps, index) => {
                        message += `${index + 1}. Data Set ID: ${ps.pdpVerifierDataSetId} (Dataset ${ps.clientDataSetId})\n`
                        message += `   Status: ${ps.isLive ? 'üü¢ Live' : 'üî¥ Not Live'}\n`
                        message += `   Current Pieces: ${ps.currentPieceCount}\n`
                        message += `   Next Piece ID: ${ps.nextPieceId}\n`
                        message += `   Service Provider: ${ps.payee}\n`
                        message += `   CDN: ${ps.withCDN ? 'Yes' : 'No'}\n`
                        message += `   Commission: ${ps.commissionBps / 100}%\n\n`
                    })
                }

                if (unmanagedDataSets.length > 0) {
                    message += `‚ö†Ô∏è OTHER DATA SETS (${unmanagedDataSets.length}):\n\n`
                    unmanagedDataSets.forEach((ps, index) => {
                        message += `${index + 1}. Data Set ID: ${ps.pdpVerifierDataSetId} (Dataset ${ps.clientDataSetId})\n`
                        message += `   Status: ${ps.isLive ? 'üü¢ Live' : 'üî¥ Not Live'} - Cannot manage from this interface\n`
                        message += `   Current Pieces: ${ps.currentPieceCount}\n`
                        message += `   Service Provider: ${ps.payee}\n`
                        message += `   CDN: ${ps.withCDN ? 'Yes' : 'No'}\n\n`
                    })
                }

                if (managedDataSets.length > 0) {
                    message += '‚ú® Auto-selected the first managed data set for adding pieces.'
                } else {
                    message += '‚ùå No data sets managed by this Warm Storage contract. You cannot add pieces from this interface.'
                }

                showStatus(message, managedDataSets.length > 0 ? 'success' : 'info')

                // Auto-populate the first MANAGED data set if found
                if (managedDataSets.length > 0) {
                    const firstManaged = managedDataSets[0]
                    // Use PDPVerifier data set ID throughout
                    document.getElementById('pdpVerifierDataSetId').value = firstManaged.pdpVerifierDataSetId
                    document.getElementById('addPiecesClientDataSetId').value = firstManaged.clientDataSetId
                    document.getElementById('nextPieceId').value = firstManaged.nextPieceId
                } else {
                    // Clear the fields if no managed data sets
                    document.getElementById('pdpVerifierDataSetId').value = ''
                    document.getElementById('addPiecesClientDataSetId').value = ''
                    document.getElementById('nextPieceId').value = ''
                }
            } catch (error) {
                console.error('Error discovering data sets:', error)
                showStatus(`Error: ${error.message}`, 'error')
            }
        })

        document.getElementById('autoFillAddPiecesInfo').addEventListener('click', async () => {
            try {
                if (!warmStorageService) {
                    showStatus('Please connect your wallet first', 'error')
                    return
                }

                const dataSetId = parseInt(document.getElementById('pdpVerifierDataSetId').value, 10)
                if (Number.isNaN(dataSetId) || dataSetId < 0) {
                    showStatus('Please enter a valid data set ID first', 'error')
                    return
                }

                showStatus('Getting add pieces information...', 'info')

                try {
                    const dataSets = await warmStorageService.getClientDataSetsWithDetails(connectedAddress)
                    const dataSet = dataSets.find(ps => ps.pdpVerifierDataSetId === dataSetId)

                    if (!dataSet) {
                        showStatus('Data set not found or not owned by connected wallet', 'error')
                        return
                    }

                    if (!dataSet.isManaged) {
                        showStatus('This data set is not managed by the current Warm Storage contract', 'error')
                        return
                    }

                    const addPiecesInfo = await warmStorageService.getAddPiecesInfo(dataSet.pdpVerifierDataSetId)

                    // Keep the data set ID as entered
                    document.getElementById('addPiecesClientDataSetId').value = addPiecesInfo.clientDataSetId
                    document.getElementById('nextPieceId').value = addPiecesInfo.nextPieceId

                    showStatus(`Auto-filled:
Data Set ID: ${dataSetId}
Client Dataset ID: ${addPiecesInfo.clientDataSetId}
Next Piece ID: ${addPiecesInfo.nextPieceId}
Current pieces in data set: ${addPiecesInfo.currentPieceCount}`, 'success')
                } catch (error) {
                    console.error('Error getting add pieces info:', error)
                    showStatus(`Error: ${error.message}`, 'error')
                }
            } catch (error) {
                console.error('Error getting add pieces info:', error)
                console.error(error.stack)
                showStatus(`Error: ${error.message}`, 'error')
            }
        })

        // Warm Storage address change handler
        document.getElementById('warmStorageAddress').addEventListener('change', async () => {
            const newAddress = document.getElementById('warmStorageAddress').value.trim()

            if (!newAddress) {
                showStatus('Warm Storage address cannot be empty', 'error')
                return
            }

            if (!ethers.isAddress(newAddress)) {
                showStatus('Invalid Warm Storage contract address format', 'error')
                return
            }

            if (!provider) {
                showStatus('Please connect MetaMask first before changing Warm Storage address', 'error')
                return
            }

            try {
                // Reinitialize Warm StorageService with new address
                warmStorageService = new WarmStorageService(provider, newAddress)
                showStatus(`Warm StorageService reinitialized with address: ${newAddress}`, 'success')
            } catch (error) {
                showStatus(`Failed to reinitialize Warm StorageService: ${error.message}`, 'error')
            }
        })

        // List providers button handler
        document.getElementById('listProvidersBtn').addEventListener('click', async () => {
            try {
                if (!warmStorageService) {
                    showStatus('Please connect your wallet first', 'error')
                    return
                }

                const providersDiv = document.getElementById('providersStatus')
                providersDiv.textContent = 'Loading approved providers...'
                providersDiv.className = 'status info'
                providersDiv.style.display = 'block'

                const providers = await warmStorageService.getAllApprovedProviders()

                if (providers.length === 0) {
                    providersDiv.textContent = 'No approved service providers found'
                    return
                }

                let message = `Found ${providers.length} approved service provider(s):\n\n`
                providers.forEach((provider, index) => {
                    message += `${index + 1}. ${provider.owner}\n`
                    message += `   PDP URL: ${provider.pdpUrl}\n`
                    message += `   Retrieval URL: ${provider.pieceRetrievalUrl}\n`
                    message += `   Registered: Block ${provider.registeredAt}\n`
                    message += `   Approved: Block ${provider.approvedAt}\n\n`
                })

                providersDiv.textContent = message
                providersDiv.className = 'status success'
            } catch (error) {
                console.error('Error listing providers:', error)
                const providersDiv = document.getElementById('providersStatus')
                providersDiv.textContent = `Error: ${error.message}`
                providersDiv.className = 'status error'
                providersDiv.style.display = 'block'
            }
        })

        // Monitor transaction button handler
        document.getElementById('monitorTxBtn').addEventListener('click', async () => {
            try {
                const txHash = document.getElementById('monitorTxHash').value.trim()
                if (!txHash) {
                    showStatus('Please enter a transaction hash', 'error')
                    return
                }

                if (!warmStorageService) {
                    showStatus('Please connect your wallet first', 'error')
                    return
                }

                const pdpEndpoint = document.getElementById('pdpEndpoint').value
                if (!pdpEndpoint) {
                    showStatus('Please enter a PDP server endpoint', 'error')
                    return
                }

                showStatus('Checking transaction status...', 'info')

                const warmStorageAddress = document.getElementById('warmStorageAddress').value
                const authHelper = new PDPAuthHelper(warmStorageAddress, connectedSigner, currentNetwork === 'mainnet' ? 314 : 314159)
                const pdpServer = new PDPServer(authHelper, pdpEndpoint, pdpEndpoint)

                const comprehensiveStatus = await warmStorageService.getComprehensiveDataSetStatus(txHash, pdpServer)

                // Build detailed status message
                let statusMessage = `üîç Transaction Status for ${txHash.slice(0, 10)}...:\n\n`

                // Summary details
                statusMessage += `üìä Overall Status: ${comprehensiveStatus.summary.isComplete ? 'Complete' : 'In Progress'}\n`
                if (comprehensiveStatus.summary.error) {
                    statusMessage += `‚ùå Error: ${comprehensiveStatus.summary.error}\n`
                }
                if (comprehensiveStatus.summary.dataSetId) {
                    statusMessage += `‚úÖ Data Set ID: ${comprehensiveStatus.summary.dataSetId}\n`
                }
                statusMessage += `\n`

                // Chain verification details
                const chain = comprehensiveStatus.chainStatus
                statusMessage += `‚õìÔ∏è On-Chain Status:\n`
                statusMessage += `  ‚Ä¢ Transaction Mined: ${chain.transactionMined ? '‚úÖ' : '‚è≥'}\n`
                if (chain.transactionMined) {
                    statusMessage += `  ‚Ä¢ Transaction Success: ${chain.transactionSuccess ? '‚úÖ' : '‚ùå'}\n`
                    statusMessage += `  ‚Ä¢ Block Number: ${chain.blockNumber ?? 'N/A'}\n`
                    statusMessage += `  ‚Ä¢ Gas Used: ${chain.gasUsed != null ? chain.gasUsed.toString() : 'N/A'}\n`
                }
                if (chain.dataSetId != null) {
                    statusMessage += `  ‚Ä¢ Data Set Live: ${chain.dataSetLive ? '‚úÖ' : '‚ùå'}\n`
                }

                const statusType = comprehensiveStatus.summary.error ? 'error' : (comprehensiveStatus.summary.isComplete ? 'success' : 'info')
                showStatus(statusMessage, statusType)

            } catch (error) {
                console.error('Error checking transaction:', error)
                showStatus(`Error: ${error.message}`, 'error')
            }
        })

        // Initial setup
        updateContractAddress() // Set initial Warm Storage address based on selected network
        showStatus('Welcome to the PDP Testing Tool! Connect your MetaMask wallet to begin.', 'info')
    </script>
</body>

</html>